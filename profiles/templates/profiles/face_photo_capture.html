{% extends "core/base.html" %}
{% load static %}

{% block title %}Face Photo Capture - LusitoHub{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h3 class="mb-0">📸 Capture Face Photo</h3>
          <p class="text-muted mb-0">Use your webcam to capture a clear photo of your face for identity verification</p>
        </div>
        <div class="card-body text-center">

          <!-- Webcam video -->
          <video id="webcam" autoplay playsinline width="100%" style="border-radius: 8px; max-width: 400px;"></video>

          <!-- Captured photo preview -->
          <canvas id="canvas" class="d-none"></canvas>
          <img id="photoPreview" class="d-none mt-3 rounded shadow" style="max-width: 400px; width: 100%;"/>

          <!-- Hidden input for form -->
          <form id="facePhotoForm" method="POST" action="{% url 'profiles:upload_identity_document' 'face_photo' %}">
            {% csrf_token %}
            <input type="hidden" name="face_photo_data" id="face_photo_data">

            <!-- Action buttons -->
            <div class="mt-4">
              <button type="button" id="captureBtn" class="btn btn-primary btn-lg">📸 Capture Photo</button>
              <button type="button" id="retakeBtn" class="btn btn-secondary btn-lg d-none">🔄 Retake</button>
              <button type="submit" id="uploadBtn" class="btn btn-success btn-lg d-none">⬆ Upload Photo</button>
            </div>

            <!-- Uploading spinner -->
            <div id="loadingSpinner" class="mt-3 d-none">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Uploading...</span>
              </div>
              <p class="mt-2">Uploading your photo, please wait...</p>
            </div>
          </form>

          <!-- Instructions -->
          <div class="mt-4 text-start">
            <div class="alert alert-info">
              <h6><i class="fas fa-info-circle"></i> Instructions:</h6>
              <ul class="mb-0">
                <li>Position yourself in good lighting</li>
                <li>Look directly at the camera</li>
                <li>Ensure your face is clearly visible</li>
                <li>Remove any sunglasses or face coverings</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const video = document.getElementById('webcam');
const canvas = document.getElementById('canvas');
const photoPreview = document.getElementById('photoPreview');
const captureBtn = document.getElementById('captureBtn');
const retakeBtn = document.getElementById('retakeBtn');
const uploadBtn = document.getElementById('uploadBtn');
const loadingSpinner = document.getElementById('loadingSpinner');
const facePhotoDataInput = document.getElementById('face_photo_data');
const form = document.getElementById('facePhotoForm');

// Ask for webcam permission
navigator.mediaDevices.getUserMedia({ 
  video: { 
    width: { ideal: 640 }, 
    height: { ideal: 480 },
    facingMode: 'user'  // Use front camera on mobile
  } 
})
.then(stream => { 
  video.srcObject = stream; 
  video.style.display = 'block';
})
.catch(err => { 
  console.error('Camera error:', err);
  alert("Could not access webcam: " + err.message + "\n\nPlease ensure you've granted camera permissions and try again.");
  // Show fallback message
  video.style.display = 'none';
  document.querySelector('.card-body').innerHTML += 
    '<div class="alert alert-danger mt-3">' +
    '<strong>Camera Access Required:</strong><br>' +
    'Please grant camera permission and refresh the page to capture your face photo.' +
    '</div>';
});

// Capture snapshot
captureBtn.addEventListener('click', () => {
  if (!video.videoWidth || !video.videoHeight) {
    alert('Camera is not ready. Please wait a moment and try again.');
    return;
  }

  const context = canvas.getContext('2d');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  context.drawImage(video, 0, 0, canvas.width, canvas.height);

  // Convert to Base64 with proper formatting for Django
  const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
  facePhotoDataInput.value = dataUrl;

  // Show preview
  photoPreview.src = dataUrl;
  photoPreview.classList.remove('d-none');
  retakeBtn.classList.remove('d-none');
  uploadBtn.classList.remove('d-none');

  // Hide video & capture button
  video.classList.add('d-none');
  captureBtn.classList.add('d-none');
  
  // Stop video stream to save resources
  if (video.srcObject) {
    const tracks = video.srcObject.getTracks();
    tracks.forEach(track => track.stop());
  }
});

// Retake functionality
retakeBtn.addEventListener('click', () => {
  // Clear previous data
  facePhotoDataInput.value = '';
  photoPreview.src = '';
  
  // Hide preview elements
  photoPreview.classList.add('d-none');
  retakeBtn.classList.add('d-none');
  uploadBtn.classList.add('d-none');
  
  // Show video & capture button
  video.classList.remove('d-none');
  captureBtn.classList.remove('d-none');
  
  // Restart camera
  navigator.mediaDevices.getUserMedia({ 
    video: { 
      width: { ideal: 640 }, 
      height: { ideal: 480 },
      facingMode: 'user'
    } 
  })
  .then(stream => { 
    video.srcObject = stream; 
  })
  .catch(err => { 
    console.error('Camera restart error:', err);
    alert("Could not restart webcam: " + err.message);
  });
});

// Show spinner on upload and handle form submission
form.addEventListener('submit', (e) => {
  if (!facePhotoDataInput.value) {
    e.preventDefault();
    alert('Please capture a photo first.');
    return;
  }
  
  // Show loading state
  uploadBtn.disabled = true;
  retakeBtn.disabled = true;
  loadingSpinner.classList.remove('d-none');
  
  // The form will submit normally to the Django backend
});

// Handle messages from Django
{% if messages %}
  {% for message in messages %}
    {% if message.tags == 'success' %}
      // Redirect to profile on success
      setTimeout(() => {
        window.location.href = "{% url 'profiles:profile' %}";
      }, 2000);
    {% endif %}
  {% endfor %}
{% endif %}
</script>
{% endblock %}
