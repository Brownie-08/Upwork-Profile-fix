{% extends "core/base.html" %}
{% load static %}
{% block title %}{{ project.title }} - Chat{% endblock %}

{% block content %}
<div class="chatroom-container">
    <div class="row">
    <!-- Project Info Sidebar -->
        <div class="col-md-3 job_container">
            <div class="project-sidebar project-info-card shadow p-3">
                <div class="shadow p-3 mb-3">
                    <h5 class="mb-3">{{ project.title }}</h5>
                    <div class="project-meta">
                        <p><i class="fas fa-user"></i> Client: {{ project.client.profile.first_name }} 
                            {{ project.client.profile.middle_name }} {{ project.client.profile.last_name }}</p>
                        {% if project.freelancer %}
                            <p><i class="fas fa-code"></i> Freelancer: {{ project.freelancer.profile.first_name }} 
                                {{ project.freelancer.profile.middle_name }} {{ project.freelancer.profile.last_name }}</p>
                        {% endif %}
                        <p><i class="fas fa-money-bill"></i> Budget: E{{ project.budget }}</p>
                        <p><i class="fas fa-calendar"></i> Deadline: {{ project.deadline|date }}</p>
                    </div>
                </div>
                <!-- Project Status -->
                <div class="sidebar-section">
                    <h5 class="section-title" data-bs-toggle="collapse" data-bs-target="#statusSection">
                        ðŸ“Š Project Status <i class="fas fa-chevron-down float-end"></i>
                    </h5>
                    <div id="statusSection" class="collapse show">
                        <select id="projectStatus" class="form-select" data-bs-toggle="tooltip" title="Update project status">
                            <option value="in_progress" {% if chatroom.project.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                            <option value="completed" {% if chatroom.project.status == 'completed' %}selected{% endif %}>Completed</option>
                            <option value="on_hold" {% if chatroom.project.status == 'on_hold' %}selected{% endif %}>On Hold</option>
                        </select>
                    </div>
                </div>

                <!-- Milestones -->
                <div class="sidebar-section mt-3">
                    <h5 class="section-title" data-bs-toggle="collapse" data-bs-target="#milestonesSection">
                        ðŸŽ¯ Milestones <i class="fas fa-chevron-down float-end"></i>
                    </h5>
                    <div id="milestonesSection" class="collapse show">
                        {% for milestone in chatroom.project.milestones.all %}
                        <div class="milestone-item p-2 mb-2 {% if milestone.completed %}completed{% endif %}">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>{{ milestone.title }}</span>
                                <button class="btn btn-sm btn-outline-success btn-complete-milestone" 
                                        data-milestone-id="{{ milestone.id }}"
                                        data-bs-toggle="tooltip" 
                                        title="Mark as complete">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                        <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#milestoneModal">
                            <i class="fas fa-plus"></i> Add Milestone
                        </button>
                    </div>
                </div>

                <!-- Pinned Messages -->
                <div class="sidebar-section mt-3">
                    <h5 class="section-title" data-bs-toggle="collapse" data-bs-target="#pinnedSection">
                        ðŸ“Œ Pinned Messages <i class="fas fa-chevron-down float-end"></i>
                    </h5>
                    <div id="pinnedSection" class="collapse show">
                        <div id="pinnedMessages" class="pinned-messages">
                            <!-- Pinned messages will be populated via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <div class="col-md-9">
            <div class="chat-container mb-5">
                <div class="chat-box shadow">
                    <!-- Chat Messages Area -->
                    <div class="chat-area" role="log" aria-label="Chat messages"></div>
                    <div class="chat-messages" id="chatMessages">
                        {% for message in messages %}
                        <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %} 
                            {% if message.message_type != 'REGULAR' %}system-message{% endif %}"
                            data-message-id="{{ message.id }}"> 
                            
                            <div class="message-content">
                                <p>{{ message.content }}</p>
                                
                                {% if message.has_attachment %}
                                    <div class="attachments" role="group" aria-label="Message attachments">
                                        {% for attachment in message.attachments.all %}
                                            <div class="attachment">
                                                <i class="fas fa-paperclip"></i>
                                                <a href="{{ attachment.file.url }}" target="_blank" rel="noopener noreferrer" download>
                                                    {{ attachment.file_name }}
                                                </a>
                                                {% if attachment.description %}
                                                    <p class="attachment-description">{{ attachment.description }}</p>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-center text-muted mt-3">No messages yet. Start the conversation!</p>
                        {% endfor %}
                    </div>

                    <!-- Message Input Area -->
                    <div class="message-input">
                        <form id="messageForm" class="chat-input-form" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <label for="fileUpload" class="btn btn-outline-secondary" title="Attach files">
                                    <i class="fas fa-paperclip"></i>
                                    <input type="file" id="fileUpload" aria-label="Upload files" multiple style="display: none;" >
                                </label>
                            </div>
                            
                            <input type="text" name="content" class="form-control" placeholder="Type your message..."
                            aria-label="Message content"
                            required>
                            
                            <div class="input-group-append">
                                <button type="submit" class="btn btn-primary" aria-label="Send message">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                        <div id="uploadPreview" class="upload-preview" aria-live="polite"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Area 
    <div class="notifications-sidebar">
        <h3>Notifications</h3>
        {% for notification in unread_notifications %}
        <div class="notification-item">
            <div class="notification-content">
                {{ notification.get_notification_type_display }}
                <p>{{ notification.message.content }}</p>
            </div>
            <span class="notification-time">{{ notification.created_at|timesince }} ago</span>
        </div>
        {% endfor %}
    </div>
    -->
</div>

<!-- Milestone Modal -->
<div class="modal fade" id="milestoneModal" tabindex="-1" aria-labelledby="milestoneModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="milestoneModalLabel">Create New Milestone</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="milestoneForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="due_date" class="form-label">Due Date</label>
                        <input type="date" class="form-control" id="due_date" name="due_date" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">E</span>
                            <input type="number" class="form-control" id="amount" name="amount" step="0.01" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitMilestone">Create Milestone</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    var chatroom_id = "{{ chatroom_id }}";
</script>

<script type="text/javascript">
    var chatroom_id = "{{ chatroom_id }}";
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the modal using Bootstrap
        const milestoneModal = new bootstrap.Modal(document.getElementById('milestoneModal'));
        
        // Handle form submission
        const submitButton = document.getElementById('submitMilestone');
        const milestoneForm = document.getElementById('milestoneForm');
        
        submitButton.addEventListener('click', async function(e) {
            e.preventDefault();
            
            if (!milestoneForm.checkValidity()) {
                milestoneForm.reportValidity();
                return;
            }
            
            const formData = new FormData(milestoneForm);
            
            try {
                const response = await fetch(`/chat/${chatroom_id}/milestone/create/`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success) {
                        // Add the new milestone to the UI
                        const milestonesSection = document.getElementById('milestonesSection');
                        const newMilestone = document.createElement('div');
                        newMilestone.className = 'milestone-item p-2 mb-2';
                        newMilestone.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <span>${formData.get('title')}</span>
                                <button class="btn btn-sm btn-outline-success btn-complete-milestone" 
                                        data-milestone-id="${result.milestone_id}"
                                        data-bs-toggle="tooltip" 
                                        title="Mark as complete">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        `;
                        milestonesSection.appendChild(newMilestone);
                        
                        // Add the milestone message to the chat
                        const messagesContainer = document.getElementById('chatMessages');
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'message system-message';
                        messageDiv.dataset.messageId = result.message_id;
                        messageDiv.innerHTML = `
                            <div class="message-content">
                                <p>Created milestone: ${formData.get('title')}</p>
                            </div>
                        `;
                        messagesContainer.appendChild(messageDiv);
                        
                        // Close the modal and reset the form
                        milestoneModal.hide();
                        milestoneForm.reset();
                        
                        // Show success message
                        showAlert('Milestone created successfully!', 'success');
                    } else {
                        throw new Error(result.error || 'Failed to create milestone');
                    }
                } else if (response.status === 403) {
                    showAlert('You are not authorized to create milestones.', 'danger');
                } else {
                    throw new Error('Failed to create milestone');
                }
            } catch (error) {
                console.error('Error creating milestone:', error);
                showAlert(error.message || 'Failed to create milestone. Please try again.', 'danger');
            }
        });
        
        // Reset form when modal is closed
        document.getElementById('milestoneModal').addEventListener('hidden.bs.modal', function () {
            milestoneForm.reset();
        });
        
        // Helper function to show alerts
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            document.querySelector('.chatroom-container').insertAdjacentElement('afterbegin', alertDiv);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    });
</script>

<script>
    // JavaScript for real-time chat functionality will go here
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize WebSocket connection
        const chatSocket = new WebSocket(
            'ws://' + window.location.host + 
            '/ws/chat/' + {{ chatroom.id }} + '/'
        );

        // Message form handling
        const messageForm = document.getElementById('messageForm');
        const messagesContainer = document.getElementById('messagesContainer');
        
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            // Add message sending logic here
        });

        // Project status change handling
        const statusSelect = document.getElementById('projectStatus');
        if (statusSelect) {
            statusSelect.addEventListener('change', function() {
                // Add status change logic here
            });
        }

        // Milestone completion handling
        document.querySelectorAll('.btn-complete-milestone').forEach(button => {
            button.addEventListener('click', function() {
                // Add milestone completion logic here
            });
        });

        // Message pinning handling
        document.querySelectorAll('.btn-pin').forEach(button => {
            button.addEventListener('click', function() {
                // Add pin message logic here
            });
        });

        // File upload preview
        const fileUpload = document.getElementById('fileUpload');
        const uploadPreview = document.getElementById('uploadPreview');
        
        fileUpload.addEventListener('change', function() {
            // Add file preview logic here
        });
    });
</script>
{% endblock %}